<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>OMERO.fs Workshop - Paris 2013</title>

    <meta name="description" content="Introducing FS in OMERO 5">
    <meta name="author" content="the Open Microscopy Environment core team">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/default.css" id="theme">

    <!-- OME presentation overrides part of the default theme -->
    <link rel="stylesheet" href="css/theme/override.css">

    <!-- from Will Moore -->
    <style>
      .ome_theme {
        background-image: url("images/ome-icon-opacity.png");
        background-color: #f2f6f9;
        background-repeat: no-repeat;
        background-position: right -270px top -120px;
      }
    </style>

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body class="ome_theme">

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <section>

          <h1>FS Workshop</h1>
          <h2>Paris 2013</h2>

          <p>How OMERO 5 uses FS to preserve your original image files on OMERO.server.</p>

        </section>

        <section>

            <h1>Outline</h1>
            <ul>
                <li>Import Before FS</li>
                <li>What is FS?</li>
                <li>DEMO #1: Importing and Downloading</li>
                <li>Advantages</li>
                <li>What is a Fileset?</li>
                <li>DEMO #2: Moving and Deleting</li>
                <li>Migrating to FS</li>
                <li>Planned Work</li>
            </ul>

        </section>

        <section>

          <section>

            <h1>Importing Before FS</h1>

            <ul>
              <li>client software extracts planes from image files</li>
              <li>server stores and uses large Pixels files</li>
              <li>additionally, original files could be archived</li>
              <ul><li><em>i.e. data duplication</em></li></ul>
            </ul>

          </section>

          <section>

            <h1>Client to Server</h1>
            <h2>OMERO 4</h2>

            <img src="diagrams/from-client-v4.png" width="75%"/>

          </section>

          <section>

            <h1>Rendering Pipeline</h1>
            <h2>OMERO 4</h2>

            <ul>
              <li>clients obtain rendered images from server</li>
              <li>Pixels structure is optimized for reading</li>
              <li>rendering is thus a fast, direct process</li>
            </ul>

          </section>

          <section>

            <h1>Server to Client</h1>
            <h2>OMERO 4</h2>

            <img src="diagrams/to-client-v4.png" width="75%"/>

          </section>

        </section>

        <section>

          <section>

            <h1>What is FS?</h1>

            <ul>
              <li>stores only the original files</li>
              <ul><li><em>i.e. No data duplication</em></li></ul>
              <li>clients need only wait for file upload</li>
              <li>no file data corruption on transfer into FS</li>
              <ul>
                <li>client and server compare files to verify clean copy</li>
              </ul>
              <li>Project/Dataset, Screen/Plate hierarchy remains</li>
            </ul>

          </section>

          <section>

            <h1>Client to Server</h1>
            <h2>OMERO 5</h2>

            <img src="diagrams/from-client-v5.png" width="75%"/>

          </section>

          <section>

            <h1>Rendering Pipeline</h1>
            <h2>OMERO 5</h2>

            <ul>
              <li>managed repository holds uploaded image files</li>
              <li>Bio-Formats extracts planes from image files</li>
              <li>server now needs Bio-Formats for rendering</li>
              <li>Bio-Formats performance much improved</li>
            </ul>

          </section>

          <section>

            <h1>Server to Client</h1>
            <h2>OMERO 5</h2>

            <img src="diagrams/to-client-v5.png" width="75%"/>

          </section>

        </section>

        <section>
            <section>
                <h1>The Numbers (in secs.)</h1>
            </section>

            <section>
                <h2>SVS (~500MB)</h2>
                <center>
                    <table style="font-size: 110%; border=2px" cellspacing="10" cellpadding="10">
                    <tr>
                        <th></th>
                        <th>pre-fs</th>
                        <th>fs</th>
                    </tr>
                    <tr>
                        <td>import</td>
                        <td>53 s.</td>
                        <td>36 s.</td>
                    </tr>
                    <tr>
                        <td>pyramids</td>
                        <td>5400 s.</td>
                        <td>n/a</td>
                    </tr>
                    <tr>
                        <td>avg. plane view</td>
                        <td>0.25 s.</td>
                        <td>0.23 s.</td>
                    </tr>
                </table>
                </center>
            </section>
        </section>

        <section>

          <section>

            <h1>FS in Action</h1>
	    <h2>Importing and Downloading</h2>

            <p>We now demonstrate import and download in OMERO 5.</p>

          </section>

          <section>

            <h1>FS in Action</h1>
	    <h2>Importing and Downloading</h2>

            <ul>
              <li>file import is fast</li>
              <li>import log</li>
              <li>checksums dialog</li>
              <li>file paths popup</li>
              <li>download files, content intact</li>
            </ul>

          </section>

        </section>

        <section>

          <section>

            <h1>No Data Duplication</h1>

            <ul>
              <li>OMERO 5 does not create large Pixels files</li>
              <ul>
                <li>no duplication of image data on server</li>
              </ul>
              <li>preserve original data structure</li>
              <ul>
                <li>uploaded image files readable by other software</li>
                <li>need not duplicate image data outside FS</li>
              </ul>
            </ul>

          </section>

          <section>

            <h1>More FS Advantages</h1>

            <ul>
              <li>OMERO.server becomes master data repository</li>
              <ul>
                <li>easily share data, reproduce analyses</li>
                <li>protect against data loss on client systems</li>
              </ul>
              <li>each upload has an import log recorded</li>
              <li>Bio-Formats improvements benefit older data</li>
            </ul>

          </section>

        </section>

        <section>

          <section>

          <!-- Presenter's notes:
          =======================
          Something along the lines of "to implement this" or "while implementing this
          we realized that we were going to need to introduce a new construct..."
          -->

            <h1>What is a Fileset?</h1>

            <ul>
              <li>a set of related files</li>
              <ul>
                <li>Bio-Formats must read them together</li>
              </ul>
              <li>a set of images, arising from those files</li>
              <li>may be just one file and one image</li>
            </ul>

          </section>

          <section>
            <h1>One file produces one image</h1>
            <img src="diagrams/filesets-figure-1x1.png" width="100%"/>
          </section>
          <section>
            <h1>One file produces several images</h1>
            <img src="diagrams/filesets-figure-1xN.png" width="100%"/>
          </section>
          <section>
            <h1>Several files produce several images</h1>
            <img src="diagrams/filesets-figure-NxN.png" width="100%"/>
          </section>


          <section>

            <h1>Fileset Indivisibility</h1>

            <ul>
              <li>files must be kept together for Bio-Formats</li>
              <li>must also associate the files' images</li>
              <ul>
                <li>they need not be in the same dataset</li>
              </ul>
            </ul>

          </section>

          <section>

            <h1>Effects of Indivisibility</h1>

            <ul>
              <li>cannot break fileset by partially deleting or moving between groups</li>
              <li>repository changes should be via server API</li>
              <li>server prohibits certain acts on partial filesets</li>
              <ul>
                <li>only operations affecting file accessibility</li>
                <li>namely: change group, delete</li>
              </ul>
            </ul>

          </section>

        </section>

        <section>

          <section>

            <h1>FS in Action</h1>
	    <h2>Moving and Deleting</h2>

            <p>We now demonstrate move and delete in OMERO 5.</p>

          </section>

          <section>

            <h1>FS in Action</h1>
	    <h2>Moving and Deleting</h2>

            <ul>
              <li>change group: partial fails</li>
              <li>change group: complete succeeds</li>
              <li>delete: partial fails</li>
              <li>delete: complete succeeds</li>
              <li>split fileset images across datasets</li>
            </ul>

          </section>

        </section>

        <section>

            <section>
                <h1>Migrating to FS</h1>
                <img src="diagrams/milestones.png" width="100%"/>
            </section>
            <section>
                <h1>Migrating to FS</h1>
                <img src="diagrams/milestones2.png" width="100%"/>
            </section>

            <section>

            <h1>Migrating to FS</h1>

            <ul>
                <li>new OMERO users should try out OMERO 5</li>
                <ul>
                <li>upgrades will be provided between each beta</li>
                <li>and to the final 5.0.0 version, of course</li>
                </ul>
                <li>upgrades from OMERO 4 currently being tested</li>
                <ul>
                <li>process for upgrade to be released after summer</li>
                </ul>
                <li>no near-term plans to allow merging servers!</li>
            </ul>

            </section>

        </section>

        <section>

          <section>

            <h1>Planned Work</h1>

            <ul>
              <li>detect any file corruption even after upload</li>
              <ul>
                <li>ensure that every file has a checksum noted</li>
                <li>re-validate checksums and report mismatches</li>
              </ul>
              <li>reconsider fileset handling (deletion, etc.)</li>
              <ul>
                <li>server-side re-import recovers image?</li>
              </ul>
            </ul>

          </section>

          <section>

            <h1>Next-Generation FS</h1>

            <ul>
              <li>import without Bio-Formats on clients</li>
              <ul>
                <li>all file format scanning done on server</li>
                <li>ability to upload unknown file formats</li>
              </ul>
              <li>server renders images from user-managed directories</li>
              <ul>
                <li>could be from remote network mount</li>
                <li>user need not use importer to upload files</li>
              </ul>
            </ul>

          </section>

        </section>

        <section>

          <h1>Any Feedback?</h1>

          <ul>
            <li>We welcome questions and comments on FS.</li>
            <li>What further work on FS would be  most useful?</li>
            <li>Would you like to try out FS at your site?</li>
          </ul>

        </section>

        <section>

          <section>
            <h2>The managed repository</h2>
            <pre>
/home/data/sample$ tree  zeiss-lsm-martin/  # Files local to client
zeiss-lsm-martin/
├── 01-01.lsm
├── 01-02.lsm
└── 051215-j-tf.mdb

            </pre>
            <hr/>
            <pre>
/OMERO/ManagedRepository/josh_0$ tree .    # Files on the server
.
├── 2013-06
│   ├── 17
│   │   ├── 09-02-55.180
│   │   │   ├── 01-01.lsm
│   │   │   ├── 01-02.lsm
│   │   │   └── 051215-j-tf.mdb
│   │   ├── 09-02-55.180.log
            </pre>
          </section>

          <section>

            <h1>Configuring FS</h1>
            <h2>etc/omero.properties</h2>
            <h3>Managed Repository Directory</h3>

            <pre>omero.data.dir=/OMERO/
omero.managed.dir=${omero.data.dir}/ManagedRepository</pre>

          </section>

          <section>

            <h1>Configuring FS</h1>
            <h2>etc/omero.properties</h2>
            <h3>Template Paths</h3>

            <pre>omero.fs.repo.path=%user%_%userId%/%year%-%month%/%day%/%time%</pre>

          </section>

          <section>

            <h1>Configuring FS</h1>
            <h2>etc/omero.properties</h2>
            <h3>Permitted File Naming</h3>

            <pre>omero.fs.repo.path_rules=Windows required, UNIX required</pre>

          </section>

          <section>

            <h1>Configuring FS</h1>
            <h2>etc/omero.properties</h2>
            <h3>Default Checksum Algorithm</h3>

            <pre>omero.checksum.default=SHA1-160</pre>

          </section>

        </section>

        <section>

          <section>

            <h1>FS in SQL</h1>
            <h2>Find an Image's Fileset</h2>

            <pre>SELECT fileset FROM image WHERE id = ?</pre>

          </section>

          <section>

            <h1>FS in SQL</h1>
            <h2>Find Images in Fileset</h2>

            <pre>SELECT name FROM image WHERE fileset = ?</pre>

          </section>

          <section>

            <h1>FS in SQL</h1>
            <h2>Find Paths of Files in Fileset</h2>

            <pre>SELECT of.path || of.name 
FROM originalfile of, filesetentry fse 
WHERE of.id = fse.originalfile 
AND fse.fileset = ?</pre>

          </section>

          <section>

            <h1>FS in SQL</h1>
            <h2>Find Checksums of Files in Fileset</h2>

            <pre>SELECT of.name, ca.value, of.hash 
FROM originalfile of, filesetentry fse, checksumalgorithm ca 
WHERE of.hasher = ca.id 
AND of.id = fse.originalfile 
AND fse.fileset = ?</pre>

          </section>

        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: 'sky', // Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

  </body>
</html>
